name: Auto Redeem Coupons

on:
  schedule:
    # Run at 00:00 and 12:00 UTC every day
    - cron: '0 0,12 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  redeem:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch coupons from Claude
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_MODEL: ${{ vars.CLAUDE_MODEL }}
          CLAUDE_PROMPT: ${{ vars.CLAUDE_PROMPT }}
        run: |
          # Build JSON payload with properly escaped prompt
          PAYLOAD=$(jq -n \
            --arg model "$CLAUDE_MODEL" \
            --arg prompt "$CLAUDE_PROMPT" \
            '{
              model: $model,
              max_tokens: 1024,
              messages: [{ role: "user", content: $prompt }]
            }')

          RESPONSE=$(curl -s "https://api.anthropic.com/v1/messages" \
            -H 'Content-Type: application/json' \
            -H 'anthropic-version: 2023-06-01' \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -d "$PAYLOAD")

          # Extract the JSON array from response
          CODES=$(echo "$RESPONSE" | jq -r '.content[0].text')
          echo "claude_codes=$CODES" >> $GITHUB_OUTPUT
          echo "Claude returned codes: $CODES"

      - name: Fetch existing coupons
        id: existing
        env:
          APP_URL: ${{ vars.APP_URL }}
        run: |
          RESPONSE=$(curl -s "${APP_URL}/api/coupons")
          CODES=$(echo "$RESPONSE" | jq -c '.coupons')
          echo "existing_codes=$CODES" >> $GITHUB_OUTPUT
          echo "Existing codes: $CODES"

      - name: Calculate diff and redeem new codes
        env:
          APP_URL: ${{ vars.APP_URL }}
          USER_ID: ${{ secrets.USER_ID }}
          CLAUDE_CODES: ${{ steps.claude.outputs.claude_codes }}
          EXISTING_CODES: ${{ steps.existing.outputs.existing_codes }}
        run: |
          # Parse codes
          CLAUDE_ARRAY=$(echo "$CLAUDE_CODES" | jq -r '.[]' 2>/dev/null || echo "")
          EXISTING_ARRAY=$(echo "$EXISTING_CODES" | jq -r '.[]' 2>/dev/null || echo "")

          if [ -z "$CLAUDE_ARRAY" ]; then
            echo "No codes returned from Claude"
            exit 0
          fi

          # Find new codes (in Claude but not in existing)
          NEW_CODES=$(comm -23 <(echo "$CLAUDE_ARRAY" | tr '[:lower:]' '[:upper:]' | sort -u) <(echo "$EXISTING_ARRAY" | tr '[:lower:]' '[:upper:]' | sort -u))

          if [ -z "$NEW_CODES" ]; then
            echo "No new codes to redeem"
            exit 0
          fi

          echo "New codes to redeem:"
          echo "$NEW_CODES"

          # Redeem each new code
          echo "$NEW_CODES" | while read -r CODE; do
            if [ -n "$CODE" ]; then
              echo "Redeeming: $CODE"
              RESULT=$(curl -s -X POST "${APP_URL}/api/redeem" \
                -H 'Content-Type: application/json' \
                -d "{\"uid\": \"${USER_ID}\", \"couponCode\": \"${CODE}\"}")
              echo "Result: $RESULT"
              sleep 1  # Rate limit protection
            fi
          done
